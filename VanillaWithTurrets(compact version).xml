<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.6//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_6.dtd'>
<nta>
	<declaration>//type definitions:

typedef struct {
    int[-1,15] x;
    int[-1,15] y;
} Cell;

typedef struct {
    int health;
} MainTowerConfiguration;

typedef struct {
    int speed;
    int health;
    int damage;
    int spawningTime;
} EnemyConfiguration;

typedef struct {
    int range;
    int speed;
    int damage;
} TurretConfiguration;

typedef struct {
    Cell pos;
    int lifeTime;
    bool kind;
    bool available;
} EnemyRecord;

typedef struct {
    int id;
    int damage;
} TargetRecord;

//configuration definitions:

const MainTowerConfiguration MT := {10};

const EnemyConfiguration SQUARE := {3, 20, 4, 3};
const EnemyConfiguration CIRCLE := {1, 10, 2, 2};

const TurretConfiguration BASIC := {2,2,2};
const TurretConfiguration CANNON := {1,7,5};
const TurretConfiguration SNIPER := {4,20,8};

//map definitions

const Cell MAIN_POS = {15,4};

const Cell TURRET0_POS = {5,5};
const Cell TURRET1_POS = {8,2};
const Cell TURRET2_POS = {8,6};
const Cell TURRET3_POS = {14,2};
const Cell TURRET4_POS = {14,6};
const Cell TURRET5_POS = {2,3};
const Cell TURRET6_POS = {11,5};

const Cell INVALID_POS = {-1,-1};
const Cell START_POS = {0,0};

const int MAX_PATH_LENGTH = 25;

//wave parameters

const int MAX_ENEMIES := 1;
int ENEMIES_COUNT := MAX_ENEMIES;
int AVAILABLE_COUNT := 0;
int match_status := 0;

//channels and shared parameters

    //enemies --&gt; MT

    urgent chan STMT;
    int DAMAGE_TO_MT;

    //turrets --&gt; enemies

    EnemyRecord SHOOT_TABLE[MAX_ENEMIES];
    
    broadcast chan SHOOT_TO_ENEMY;
    
    TargetRecord TARGET_RECORD;
    
   // broadcast chan ENEMY_SYNC;

bool isValid (Cell c)
    {
        if (c == INVALID_POS)
            {
                return (true);
            }
        if (c.y == 7)
            {
                return (c.x&gt;=7 &amp;&amp; c.x&lt;=15);
            } 
        if (c.y == 6 || c.y == 5)
            {
                return (c.x == 7 || c.x == 10 || c.x == 15);
            }
        if (c.y == 4)
            {
                return (c.x != 8 &amp;&amp; c.x != 9);
            }
        if (c.y == 3 || c.y == 2)
            {
                return (c.x == 0 || c.x == 7 || c.x == 15);
            }
        if (c.y == 1)
            {
                return (c.x == 0 || (c.x &gt;=7 &amp;&amp; c.x&lt;=15));
            }
        if (c.y == 0)
            {
                return (c.x == 0);
            }

        return (false);
    }
void updateMatchStatus ()
    {
        if (ENEMIES_COUNT&gt;0)
            {
                match_status = 1;
            }
        else
            {
                match_status = 2;
            }

        return;
    }
bool isMatchEnded()
    {
        return (match_status == 2);
    }</declaration>
	<template>
		<name>enemySync</name>
		<location id="id0" x="-85" y="-42">
		</location>
		<location id="id1" x="-280" y="-42">
		</location>
		<init ref="id0"/>
		<transition id="id2">
			<source ref="id0"/>
			<target ref="id1"/>
			<label kind="guard" x="-246" y="-68">ENEMIES_COUNT==0</label>
		</transition>
		<transition id="id3">
			<source ref="id0"/>
			<target ref="id0"/>
			<nail x="-51" y="-68"/>
			<nail x="-51" y="0"/>
		</transition>
	</template>
	<template>
		<name>compactEnemy</name>
		<parameter>const int id, const int speed, int health, const int damage, const int spawningTime, const bool kind</parameter>
		<declaration>int c1 := 0;
int c2 := 0;
Cell pos := INVALID_POS;
int age := 0;
int choice := 0;

void initialize(int i)
    {
        pos = START_POS;
        choice = i;

        SHOOT_TABLE[id].lifeTime = 0;
        SHOOT_TABLE[id].kind = kind;
        SHOOT_TABLE[id].available = true;
        SHOOT_TABLE[id].pos = pos;
        SHOOT_TABLE[id].lifeTime = age;

        AVAILABLE_COUNT++;
        updateMatchStatus();        
    }
void takeDamage ()
    {
        if (TARGET_RECORD.id == id)
            {
                health = health - TARGET_RECORD.damage;
                TARGET_RECORD.damage = 0;
            }
    }
void dismiss ()
    {
        SHOOT_TABLE[id].available = false;
        ENEMIES_COUNT--;
        AVAILABLE_COUNT--;
        updateMatchStatus();
    }
void updateRecord ()
    {
        SHOOT_TABLE[id].pos = pos;
        age++;
        SHOOT_TABLE[id].lifeTime = age;        
    }
void next()
    {
        if (pos.x == 0)
            {
                if (pos.y &lt;=3)
                    pos.y = pos.y+1;
                else
                    if (pos.y == 4)
                        pos.x = 1;
                
                return;
            }
        if (pos.x &gt;=1 &amp;&amp; pos.x &lt;= 6)
            {
                pos.x = pos.x +1;
                return;
            }
        if (pos.x == 7)
            {
                if (pos.y == 4)
                    {
                        if (choice == 0 || choice == 1)
                            pos.y = pos.y + 1;
                        else
                            pos.y = pos.y - 1;
                    }
                else
                    if (pos.y == 5 || pos.y == 6)
                        pos.y = pos.y + 1;
                    else
                        if (pos.y == 3 || pos.y == 2)
                            pos.y = pos.y - 1;
                        else
                            if (pos.y == 7 || pos.y == 1)
                                pos.x = pos.x + 1;
                return;
            }
        if (pos.x &gt;= 8 &amp;&amp; pos.x &lt;= 9)
            {
                if (pos.y == 7 || pos.y == 1)
                    pos.x = pos.x + 1;
                return;
            }
        if (pos.x == 10)
            {
                if (pos.y == 7)
                    {
                        if (choice == 0)
                            pos.y = pos.y - 1;
                        else
                            pos.x = pos.x + 1;
                    }
                else
                    if (pos.y == 6 || pos.y == 5)
                        pos.y = pos.y - 1;
                    else
                        if (pos.y == 1 || pos.y == 4)
                            pos.x = pos.x + 1;
                return;
            }
        if (pos.x &gt;= 11 &amp;&amp; pos.x &lt;= 14)
            {
                if (pos.y == 7 || pos.y == 1 || pos.y == 4)
                    pos.x = pos.x + 1;
                return;
            }
        if (pos.x == 15)
            {
                if (pos.y &lt; 4 &amp;&amp; pos.y &gt;= 1)
                    pos.y = pos.y + 1;
                else
                    if (pos.y &gt; 4 &amp;&amp; pos.y &lt;= 7)
                        pos.y = pos.y - 1;
                return;
            }
    }</declaration>
		<location id="id4" x="501" y="433" color="#ffa500">
		</location>
		<location id="id5" x="501" y="595" color="#ff0000">
			<name x="484" y="612">dead</name>
		</location>
		<location id="id6" x="-93" y="433" color="#00ff00">
		</location>
		<location id="id7" x="501" y="246" color="#000000">
			<name x="476" y="212">ended</name>
		</location>
		<init ref="id6"/>
		<transition id="id8">
			<source ref="id6"/>
			<target ref="id4"/>
			<label kind="guard" x="34" y="484">c2==spawningTime</label>
			<label kind="assignment" x="178" y="484">initialize(2)</label>
			<nail x="0" y="510"/>
			<nail x="246" y="510"/>
			<nail x="399" y="510"/>
		</transition>
		<transition id="id9">
			<source ref="id6"/>
			<target ref="id4"/>
			<label kind="guard" x="25" y="323">c2==spawningTime</label>
			<label kind="assignment" x="170" y="323">initialize(0)</label>
			<nail x="0" y="348"/>
			<nail x="399" y="348"/>
		</transition>
		<transition id="id10">
			<source ref="id6"/>
			<target ref="id6"/>
			<label kind="guard" x="-323" y="416">c2&lt;spawningTime</label>
			<label kind="assignment" x="-187" y="416">c2++</label>
			<nail x="-144" y="450"/>
			<nail x="-144" y="399"/>
		</transition>
		<transition id="id11">
			<source ref="id4"/>
			<target ref="id4"/>
			<label kind="guard" x="578" y="425">health&gt;0</label>
			<label kind="synchronisation" x="578" y="408">SHOOT_TO_ENEMY?</label>
			<label kind="assignment" x="654" y="425">takeDamage()</label>
			<nail x="569" y="408"/>
			<nail x="569" y="442"/>
		</transition>
		<transition id="id12" color="#00ff00">
			<source ref="id6"/>
			<target ref="id4"/>
			<label kind="guard" x="34" y="408">c2==spawningTime</label>
			<label kind="assignment" x="178" y="408">initialize(1)</label>
		</transition>
		<transition id="id13" color="#ff0000">
			<source ref="id4"/>
			<target ref="id5"/>
			<label kind="guard" x="510" y="544">health&lt;=0</label>
			<label kind="assignment" x="595" y="544">dismiss()</label>
		</transition>
		<transition id="id14" color="#ffa500">
			<source ref="id4"/>
			<target ref="id7"/>
			<label kind="guard" x="510" y="297">pos == MAIN_POS &amp;&amp; health&gt;0</label>
			<label kind="synchronisation" x="510" y="280">STMT!</label>
			<label kind="assignment" x="748" y="297">DAMAGE_TO_MT = damage,dismiss()</label>
		</transition>
		<transition id="id15">
			<source ref="id4"/>
			<target ref="id4"/>
			<label kind="guard" x="552" y="476">pos != MAIN_POS &amp;&amp; c1&lt;speed &amp;&amp; health&gt;0</label>
			<label kind="assignment" x="892" y="476">c1++,updateRecord()</label>
			<nail x="535" y="484"/>
			<nail x="561" y="459"/>
		</transition>
		<transition id="id16">
			<source ref="id4"/>
			<target ref="id4"/>
			<label kind="guard" x="561" y="374">c1==speed &amp;&amp; pos != MAIN_POS &amp;&amp; health&gt;0</label>
			<label kind="assignment" x="909" y="374">next(),c1=0,updateRecord()</label>
			<nail x="527" y="374"/>
			<nail x="552" y="399"/>
		</transition>
	</template>
	<template>
		<name>turret</name>
		<parameter>int id, Cell pos, int range, int speed, int damage</parameter>
		<declaration>int c1=0;

int max (int v1, int v2)
    {
        if (v1 &gt;= v2)
            return (v1);
        else
            return (v2);
    }
int dist(const Cell c1, const Cell c2)
    {
        return (max(abs(c1.x - c2.x), abs(c1.y - c2.y)));
    }
void shoot (int id)
    {
        TARGET_RECORD.id = id;
        TARGET_RECORD.damage = damage;
        c1=speed;
    }
void target()
    {
        int i, min_id, min_dist, maxLife, cont=0, min_kind, app_i, d;
        bool app_kind;

        if (AVAILABLE_COUNT &gt; 0)
            {
                i = 0;
                while (i &lt; MAX_ENEMIES &amp;&amp; !(SHOOT_TABLE[i].available &amp;&amp; dist(SHOOT_TABLE[i].pos, pos)&lt;=range))
                    {
                        i++;
                    }
                if (i &lt; MAX_ENEMIES)
                    {
                        min_id = i;
                        min_dist = dist(SHOOT_TABLE[i].pos, pos);
                        maxLife = SHOOT_TABLE[i].lifeTime;
                        min_kind = SHOOT_TABLE[i].kind;
                        cont++;
                        for (i = app_i+1 ; i &lt; MAX_ENEMIES &amp;&amp; cont &lt; AVAILABLE_COUNT; i++)
                            {
                                if (SHOOT_TABLE[i].available)
                                    {
                                        cont++;
                                        d = dist(SHOOT_TABLE[i].pos, pos);
                                        if (d &lt;min_dist)
                                            {
                                                min_id = i;
                                                min_dist = d;
                                                maxLife = SHOOT_TABLE[i].lifeTime;
                                                min_kind = SHOOT_TABLE[i].kind;
                                            }
                                        else
                                            {        
                                                if (d == min_dist)
                                                    {
                                                        if (maxLife &lt; SHOOT_TABLE[i].lifeTime)
                                                            {
                                                                min_id = i;
                                                                maxLife = SHOOT_TABLE[i].lifeTime;
                                                                min_kind = SHOOT_TABLE[i].kind;
                                                            }
                                                        else
                                                            {
                                                                if (maxLife == SHOOT_TABLE[i].lifeTime)
                                                                    {
                                                                        if (SHOOT_TABLE[i].kind)
                                                                            {
                                                                                 min_id = i;
                                                                                 min_kind = SHOOT_TABLE[i].kind; 
                                                                            }
                                                                    }
                                                            }
                                                    }
                                            }
                                       }
                            }

                        shoot (min_id);
                    }
                else
                    {
                        return;
                    }
            }
    }
bool shootable()
    {
        int i, cont;
        
        cont=0;
        for (i = 0 ; i&lt;MAX_ENEMIES &amp;&amp; cont&lt;AVAILABLE_COUNT; i++)
            {
                if (SHOOT_TABLE[i].available)
                    {
                        cont++;
                        if (dist(SHOOT_TABLE[i].pos, pos)&lt;=range)
                           {
                               return (true);
                           }
                    }
            }

        return (false);
    }
</declaration>
		<location id="id17" x="-459" y="-306">
		</location>
		<init ref="id17"/>
		<transition id="id18">
			<source ref="id17"/>
			<target ref="id17"/>
			<label kind="guard" x="-382" y="-314">c1&gt;0 &amp;&amp; !isMatchEnded()</label>
			<label kind="assignment" x="-178" y="-314">c1=c1-1</label>
			<nail x="-391" y="-348"/>
			<nail x="-391" y="-272"/>
		</transition>
		<transition id="id19">
			<source ref="id17"/>
			<target ref="id17"/>
			<label kind="guard" x="-790" y="-314">c1==0 &amp;&amp; shootable()</label>
			<label kind="synchronisation" x="-671" y="-339">SHOOT_TO_ENEMY!</label>
			<label kind="assignment" x="-612" y="-314">target()</label>
			<nail x="-535" y="-348"/>
			<nail x="-535" y="-280"/>
		</transition>
	</template>
	<template>
		<name x="5" y="5">mainTower</name>
		<parameter>int life</parameter>
		<declaration>void decDamage()
    {
        life = life - DAMAGE_TO_MT;
        DAMAGE_TO_MT = 0;
    }</declaration>
		<location id="id20" x="-1113" y="-578" color="#00ff00">
		</location>
		<init ref="id20"/>
		<transition id="id21">
			<source ref="id20"/>
			<target ref="id20"/>
			<label kind="guard" x="-1265" y="-611">life&gt;0</label>
			<label kind="synchronisation" x="-1257" y="-594">STMT?</label>
			<label kind="assignment" x="-1282" y="-577">decDamage()</label>
			<nail x="-1164" y="-527"/>
			<nail x="-1173" y="-544"/>
			<nail x="-1173" y="-612"/>
		</transition>
		<transition id="id22">
			<source ref="id20"/>
			<target ref="id20"/>
			<label kind="guard" x="-1045" y="-578">life &lt;= 0</label>
			<label kind="synchronisation" x="-1045" y="-595">STMT?</label>
			<nail x="-1062" y="-595"/>
			<nail x="-1054" y="-535"/>
		</transition>
	</template>
	<system>circlec(const int id) = compactEnemy(id, CIRCLE.speed, CIRCLE.health, CIRCLE.damage, CIRCLE.spawningTime, false);
squarec(const int id) = compactEnemy(id, SQUARE.speed, SQUARE.health, SQUARE.damage, SQUARE.spawningTime, true);
basic(const int id, const Cell pos) = turret(id, pos, BASIC.range, BASIC.speed, BASIC.damage);
cannon(const int id, const Cell pos) = turret(id, pos, CANNON.range, CANNON.speed, CANNON.damage);
sniper(const int id, const Cell pos) = turret(id, pos, SNIPER.range, SNIPER.speed, SNIPER.damage);

enc0 = circlec(0);
enc1 = squarec(1);
enc2 = circlec(2);
enc3 = squarec(3);
enc4 = circlec(4);
enc5 = squarec(5);
enc6 = circlec(6);
enc7 = squarec(7);
mt = mainTower(MT.health);
t0 = basic(0, TURRET0_POS);
t1 = cannon(1, TURRET1_POS);
t2 = cannon(2, TURRET2_POS);
t3 = cannon(3, TURRET3_POS);
t4 = cannon(4, TURRET4_POS);
t5 = sniper(5, TURRET5_POS);
t6 = sniper(6, TURRET6_POS);
//ens = enemySync();
system mt,enc0, t0, t1, t2, t3, t4, t5, t6;//, enc2;// t0, t1, t2, t3, t4, t5, t6;//, t0, t1, t2, t3, t4, t5, t6, ens;//, t0;//, enc2;//, enc1;//, enc1, enc2;//, t0, t5;//, en1, t0, t5;




</system>
	<queries>
		<query>
			<formula>A[](deadlock imply isMatchEnded())</formula>
			<comment/>
		</query>
		<query>
			<formula>E&lt;&gt;(enc0.pos == MAIN_POS)</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-05-19 06:30:00 +0200">
			</result>
		</query>
		<query>
			<formula>A[](enc0.pos == MAIN_POS imply enc0.age&lt;=(MAX_PATH_LENGTH*(CIRCLE.speed+1)))</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-05-19 06:30:08 +0200">
			</result>
		</query>
		<query>
			<formula>A[](enc1.pos == MAIN_POS imply enc1.age&lt;=(MAX_PATH_LENGTH*(SQUARE.speed+1)))</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-05-18 17:38:05 +0200">
			</result>
		</query>
		<query>
			<formula>A[](isValid(enc0.pos) &amp;&amp; isValid(enc1.pos))</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-05-18 17:38:09 +0200">
			</result>
		</query>
		<query>
			<formula>E&lt;&gt;(mt.life &lt;= 0)</formula>
			<comment/>
			<result outcome="failure" type="quality" timestamp="2025-05-18 17:38:22 +0200">
			</result>
		</query>
	</queries>
</nta>
