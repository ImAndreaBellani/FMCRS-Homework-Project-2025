<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.6//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_6.dtd'>
<nta>
	<declaration>//configurations definitions:

const int[5,5] MAX_ENEMIES := 5; //how many enemies will eventually get into the match
const int[7,7] MAX_TURRETS := 7;

//objects definitions:

typedef struct {
    int health;
} MainTowerConfiguration;

typedef struct {
    int speed;
    int health;
    int damage;
    int spawningTime;
    bool kind;
} EnemyConfiguration;

typedef struct {
    int range;
    int speed;
    int damage;
} TurretConfiguration;

const MainTowerConfiguration MT := {10};

const EnemyConfiguration SQUARE := {3, 20, 4, 3, true};
const EnemyConfiguration CIRCLE := {1, 10, 2, 2, false};

const TurretConfiguration BASIC := {2,2,2};
const TurretConfiguration CANNON := {1,7,5};
const TurretConfiguration SNIPER := {4,20,8};

//map's definitions:

const int MAX_CELL_X := 15;
const int MIN_CELL_X := -1;
const int MAX_CELL_Y := 7;
const int MIN_CELL_Y := -1;
  
typedef struct {
    int[MIN_CELL_X,MAX_CELL_X] x;
    int[MIN_CELL_Y,MAX_CELL_Y] y;
} Cell;

const int[25,25] MAX_PATH_LENGTH := 25;

typedef int Life_t;

const Cell MAIN_POS := {15,4};

const Cell INVALID_POS := {-1,-1};
const Cell START_POS := {0,0};

const Cell turrets_board[MAX_TURRETS] := {{5,5},{8,2},{8,6},{14,2},{14,6},{2,3},{11,5}};

// wave-related definitions:

typedef int[-1,MAX_ENEMIES-1] EnemyID_t;
typedef int[0,MAX_TURRETS-1] TurretID_t;

typedef struct {
    Cell pos;
    Life_t lifeTime;
    bool kind;
    bool available;
} EnemyRecord;

typedef struct {
    EnemyID_t id;
    int damage;
} TargetRecord;

typedef struct {
    Cell pos;
    bool ready;
    int range;
} TurretRecord;

//shoot stuff:

EnemyRecord shoot_table[MAX_ENEMIES];
TargetRecord target_record := {-1,0};

int[-20,MT.health] mt_life := MT.health;

int[0,MAX_ENEMIES] left_enemies := MAX_ENEMIES; //how many enemies are currently alive or about to spawn
int[0,MAX_ENEMIES] available_enemies := 0; //how many enemies are currently available (already spawned and not dead)

urgent broadcast chan SHOOT_TO_ENEMY;

//useful procedures:

bool isValid (Cell c)
    {
        if (c == INVALID_POS)
            {
                return (true);
            }
        if (c.y == 7)
            {
                return (c.x&gt;=7 &amp;&amp; c.x&lt;=15);
            } 
        if (c.y == 6 || c.y == 5)
            {
                return (c.x == 7 || c.x == 10 || c.x == 15);
            }
        if (c.y == 4)
            {
                return (c.x != 8 &amp;&amp; c.x != 9);
            }
        if (c.y == 3 || c.y == 2)
            {
                return (c.x == 0 || c.x == 7 || c.x == 15);
            }
        if (c.y == 1)
            {
                return (c.x == 0 || (c.x &gt;=7 &amp;&amp; c.x&lt;=15));
            }
        if (c.y == 0)
            {
                return (c.x == 0);
            }

        return (false);
    }
int dist(const Cell c1, const Cell c2)
    {
        int[-1,15] v1=abs(c1.x - c2.x), v2=abs(c1.y - c2.y);

        if (v1&gt;=v2)
            return (v1);
        else
            return (v2);
    }
bool matchEnded()
    {
        return (left_enemies == 0);
    }</declaration>
	<template>
		<name>compactEnemy</name>
		<parameter>const EnemyID_t id, const int speed, int health, const int damage, const int spawningTime, const bool kind</parameter>
		<declaration>clock x;
clock z;
Cell pos := INVALID_POS;
int[0,2] chosenPath := 0;

void initialize(const int[0,2] i)
    {
        pos = START_POS;
        chosenPath = i;

        shoot_table[id].kind = kind;
        shoot_table[id].available = true;
        shoot_table[id].pos = pos;
        shoot_table[id].lifeTime = 0;

        available_enemies++;
        
        x = 0;
        z = 0;
    }
void shoot()
    {
        if (mt_life &gt; 0)
            mt_life = mt_life - damage;
    }
void dismiss ()
    {
       shoot_table[id].available = false;
       left_enemies--;
       available_enemies--;
    }
void takeDamage ()
    {
       
        if (target_record.id == id)
            {
                health = health - target_record.damage;
                target_record.damage = 0;
                target_record.id = -1;
                if (health &lt;= 0)
                    dismiss();
            }
    }
void next()
    {  
          if (pos.x == 0)
            {
                if (pos.y &lt;=3)
                    pos.y = pos.y+1;
                else
                    if (pos.y == 4)
                        pos.x = 1;
                
                return;
            }
        if (pos.x &gt;=1 &amp;&amp; pos.x &lt;= 6)
            {
                pos.x = pos.x +1;
                return;
            }
        if (pos.x == 7)
            {
                if (pos.y == 4)
                    {
                        if (chosenPath == 0 || chosenPath == 1)
                            pos.y = pos.y + 1;
                        else
                            pos.y = pos.y - 1;
                    }
                else
                    if (pos.y == 5 || pos.y == 6)
                        pos.y = pos.y + 1;
                    else
                        if (pos.y == 3 || pos.y == 2)
                            pos.y = pos.y - 1;
                        else
                            if (pos.y == 7 || pos.y == 1)
                                pos.x = pos.x + 1;
                return;
            }
        if (pos.x &gt;= 8 &amp;&amp; pos.x &lt;= 9)
            {
                if (pos.y == 7 || pos.y == 1)
                    pos.x = pos.x + 1;
                return;
            }
        if (pos.x == 10)
            {
                if (pos.y == 7)
                    {
                        if (chosenPath == 0)
                            pos.y = pos.y - 1;
                        else
                            pos.x = pos.x + 1;
                    }
                else
                    if (pos.y == 6 || pos.y == 5)
                        pos.y = pos.y - 1;
                    else
                        if (pos.y == 1 || pos.y == 4)
                            pos.x = pos.x + 1;
                return;
            }
        if (pos.x &gt;= 11 &amp;&amp; pos.x &lt;= 14)
            {
                if (pos.y == 7 || pos.y == 1 || pos.y == 4)
                    pos.x = pos.x + 1;
                return;
            }
        if (pos.x == 15)
            {
                if (pos.y &lt; 4 &amp;&amp; pos.y &gt;= 1)
                    pos.y = pos.y + 1;
                else
                    if (pos.y &gt; 4 &amp;&amp; pos.y &lt;= 7)
                        pos.y = pos.y - 1;
                return;
            }
    }
bool canMove()
    {
        return (pos!=MAIN_POS &amp;&amp; health&gt;0);
    }
bool readyToShoot()
    {
        return (pos==MAIN_POS &amp;&amp; health&gt;0);
    }</declaration>
		<location id="id0" x="357" y="425" color="#00ff00">
			<label kind="invariant" x="229" y="365">z&lt;=1 &amp;&amp; x &lt;=speed</label>
		</location>
		<location id="id1" x="-110" y="510" color="#00ffff">
			<label kind="invariant" x="-161" y="518">x&lt;=spawningTime</label>
		</location>
		<location id="id2" x="467" y="263" color="#ffa500">
			<name x="399" y="136">afterShot</name>
			<label kind="invariant" x="416" y="161">x&lt;=speed &amp;&amp; z&lt;=1</label>
		</location>
		<location id="id3" x="229" y="263" color="#ff0000">
			<name x="204" y="229">ended</name>
		</location>
		<init ref="id1"/>
		<transition id="id4">
			<source ref="id2"/>
			<target ref="id3"/>
			<label kind="guard" x="306" y="187">health&lt;0</label>
			<nail x="391" y="204"/>
		</transition>
		<transition id="id5">
			<source ref="id2"/>
			<target ref="id2"/>
			<label kind="guard" x="535" y="272">z&gt;=1 &amp;&amp; x&lt;speed &amp;&amp; health&gt;0</label>
			<label kind="assignment" x="535" y="289">shoot_table[id].lifeTime++,z=0</label>
			<nail x="527" y="289"/>
			<nail x="527" y="272"/>
		</transition>
		<transition id="id6">
			<source ref="id2"/>
			<target ref="id2"/>
			<label kind="guard" x="484" y="187">health&gt;0</label>
			<label kind="synchronisation" x="510" y="204">SHOOT_TO_ENEMY?</label>
			<label kind="assignment" x="518" y="221">takeDamage()</label>
			<nail x="467" y="204"/>
			<nail x="510" y="221"/>
		</transition>
		<transition id="id7">
			<source ref="id0"/>
			<target ref="id0"/>
			<label kind="guard" x="408" y="382">z&gt;=1 &amp;&amp; x&lt;speed &amp;&amp; canMove()</label>
			<label kind="assignment" x="408" y="399">shoot_table[id].lifeTime++,z=0</label>
			<nail x="399" y="391"/>
			<nail x="408" y="425"/>
		</transition>
		<transition id="id8">
			<source ref="id2"/>
			<target ref="id3"/>
			<label kind="guard" x="280" y="238">x&gt;=speed &amp;&amp; health&gt;0</label>
			<label kind="assignment" x="314" y="263">dismiss()</label>
		</transition>
		<transition id="id9">
			<source ref="id0"/>
			<target ref="id3"/>
			<label kind="guard" x="161" y="289">health&lt;=0</label>
		</transition>
		<transition id="id10">
			<source ref="id0"/>
			<target ref="id0"/>
			<label kind="guard" x="297" y="501">health&gt;0</label>
			<label kind="synchronisation" x="272" y="484">SHOOT_TO_ENEMY?</label>
			<label kind="assignment" x="280" y="518">takeDamage()</label>
			<nail x="323" y="467"/>
			<nail x="348" y="484"/>
		</transition>
		<transition id="id11">
			<source ref="id0"/>
			<target ref="id0"/>
			<label kind="guard" x="399" y="433">z&gt;=1 &amp;&amp; x&gt;=speed &amp;&amp; canMove()</label>
			<label kind="assignment" x="399" y="450">next(),shoot_table[id].pos =pos,shoot_table[id].lifeTime++,x=0,z=0</label>
			<nail x="374" y="476"/>
			<nail x="399" y="459"/>
		</transition>
		<transition id="id12">
			<source ref="id1"/>
			<target ref="id0"/>
			<label kind="guard" x="-68" y="484">x&gt;=spawningTime</label>
			<label kind="assignment" x="76" y="484">initialize(2)</label>
			<nail x="-25" y="510"/>
			<nail x="187" y="510"/>
		</transition>
		<transition id="id13">
			<source ref="id1"/>
			<target ref="id0"/>
			<label kind="guard" x="-102" y="365">x&gt;=spawningTime</label>
			<label kind="assignment" x="42" y="365">initialize(0)</label>
			<nail x="-110" y="391"/>
			<nail x="187" y="391"/>
		</transition>
		<transition id="id14">
			<source ref="id1"/>
			<target ref="id0"/>
			<label kind="guard" x="-51" y="416">x&gt;=spawningTime</label>
			<label kind="assignment" x="93" y="416">initialize(1)</label>
			<nail x="-59" y="442"/>
			<nail x="204" y="442"/>
		</transition>
		<transition id="id15">
			<source ref="id0"/>
			<target ref="id2"/>
			<label kind="guard" x="450" y="306">readyToShoot()</label>
			<label kind="assignment" x="433" y="323">shoot(), x=0, z=0</label>
		</transition>
	</template>
	<template>
		<name>turret</name>
		<parameter>const TurretID_t id, const int range, const int speed, const int damage</parameter>
		<declaration>clock y;

void shoot (const EnemyID_t targetId)
    {
        target_record.id = targetId;
        target_record.damage = damage;
        y=0;
    }
void target()
    {
        bool found;
        int[0,MAX_ENEMIES] i, cont=0;
        EnemyID_t target_id;
        int[-1,15] target_dist, d;
        Life_t target_lifeTime;

        if (available_enemies &gt; 0)
            {
                i = 0;
                found = false;
                while (i &lt; MAX_ENEMIES &amp;&amp; !found)
                    {
                        if (shoot_table[i].available &amp;&amp; dist(shoot_table[i].pos, turrets_board[id])&lt;=range)
                            {
                                found = true;
                            }
                        i++;
                    }
                if (found)
                    {
                        target_id = i-1;
                        target_dist = dist(shoot_table[i-1].pos, turrets_board[id]);
                        target_lifeTime = shoot_table[i-1].lifeTime;
                        cont++;
                        for (i = i ; i&lt;MAX_ENEMIES &amp;&amp; cont &lt; available_enemies; i++)
                            {
                                if (shoot_table[i].available)
                                    {
                                        cont++;
                                        d = dist(shoot_table[i].pos, turrets_board[id]);
                                        if (d &lt;target_dist)
                                            {
                                                target_id = i;
                                                target_dist = d;
                                                target_lifeTime = shoot_table[i].lifeTime;
                                            }
                                        else
                                            {        
                                                if (d == target_dist)
                                                    {
                                                        if (shoot_table[i].lifeTime &lt; target_lifeTime)
                                                            {
                                                                target_id = i;
                                                                target_lifeTime = shoot_table[i].lifeTime;
                                                            }
                                                        else
                                                            {
                                                                if (target_lifeTime == shoot_table[i].lifeTime)
                                                                    {
                                                                        if (shoot_table[i].kind)
                                                                            {
                                                                                 target_id = i;
                                                                            }
                                                                    }
                                                            }
                                                    }
                                            }
                                       }
                            }

                        shoot (target_id);
                    }
        }   
    }
bool shootable()
    {
        int[0,MAX_ENEMIES] i, cont;
        
        cont=0;
        for (i = 0 ; i&lt;MAX_ENEMIES &amp;&amp; cont&lt;available_enemies; i++)
            {
                if (shoot_table[i].available)
                    {
                        cont++;
                        if (dist(shoot_table[i].pos, turrets_board[id])&lt;=range)
                           {
                               return (true);
                           }
                    }
            }

        return (false);
    }
</declaration>
		<location id="id16" x="-459" y="-306" color="#00ff00">
			<name x="-469" y="-340">readyToShoot</name>
		</location>
		<location id="id17" x="-697" y="-306" color="#ffa500">
			<name x="-722" y="-340">wait</name>
			<label kind="invariant" x="-790" y="-323">y&lt;=speed</label>
		</location>
		<init ref="id16"/>
		<transition id="id18">
			<source ref="id17"/>
			<target ref="id16"/>
			<label kind="guard" x="-604" y="-221">y&gt;=speed</label>
			<nail x="-698" y="-221"/>
			<nail x="-460" y="-221"/>
		</transition>
		<transition id="id19">
			<source ref="id16"/>
			<target ref="id17"/>
			<label kind="guard" x="-629" y="-374">shootable()</label>
			<label kind="synchronisation" x="-646" y="-348">SHOOT_TO_ENEMY!</label>
			<label kind="assignment" x="-612" y="-331">target()</label>
			<nail x="-578" y="-306"/>
		</transition>
	</template>
	<system>circle(const int[0,2] id) = compactEnemy(id, CIRCLE.speed, CIRCLE.health, CIRCLE.damage, (id)*CIRCLE.spawningTime, CIRCLE.kind);
square(const int[3,5] id) = compactEnemy(id, SQUARE.speed, SQUARE.health, SQUARE.damage, (id-3)*SQUARE.spawningTime, SQUARE.kind);
basic(const int[0,0] id) = turret(id,BASIC.range, BASIC.speed, BASIC.damage);
cannon(const int[1,4] id) = turret(id,CANNON.range, CANNON.speed, CANNON.damage);
sniper(const int[5,6] id) = turret(id,SNIPER.range, SNIPER.speed, SNIPER.damage);

system circle,square,basic,cannon, sniper;




</system>
	<queries>
		<query>
			<formula>A[](deadlock imply matchEnded())</formula>
			<comment/>
		</query>
		<query>
			<formula>E&lt;&gt;(forall(i:int[0,2])(circle(i).pos == MAIN_POS) &amp;&amp; forall(i:int[3,5])(square(i).pos == MAIN_POS))</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-06-01 10:07:51 +0200">
			</result>
		</query>
		<query>
			<formula>A[](
	(forall(i:int[0,MAX_ENEMIES-1])((shoot_table[i].pos == MAIN_POS &amp;&amp; !shoot_table[i].kind) imply shoot_table[i].lifeTime==(MAX_PATH_LENGTH*CIRCLE.speed))) &amp;&amp;
	(forall(i:int[0,MAX_ENEMIES-1])((shoot_table[i].pos == MAIN_POS &amp;&amp; shoot_table[i].kind) imply shoot_table[i].lifeTime==(MAX_PATH_LENGTH*SQUARE.speed)))
)</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-06-01 10:08:18 +0200">
			</result>
		</query>
		<query>
			<formula>A[](forall(i:int[0,2])(isValid(circle(i).pos)) &amp;&amp; forall(i:int[3,5])(isValid(square(i).pos)))</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-06-01 10:08:47 +0200">
			</result>
		</query>
		<query>
			<formula>A[](mt_life &gt; 0)</formula>
			<comment/>
			<result outcome="success" type="quality" timestamp="2025-05-28 09:33:08 +0200">
			</result>
		</query>
	</queries>
</nta>
